#!/bin/sh

set -eu

usage() {
  cat <<'EOF'
Usage: casacore_cov

Run from a casacore build tree (root, module directory, or */test directory).

Environment:
  CTEST_REGEX  Optional regex passed via ctest -R.
  CTEST_ARGS   Additional arguments forwarded to ctest (for example: "--output-on-failure").
EOF
}

if [ "${1:-}" = "-h" ] || [ "${1:-}" = "--help" ]; then
  usage
  exit 0
fi

for tool in ctest lcov genhtml; do
  if ! command -v "${tool}" >/dev/null 2>&1; then
    echo "Missing required tool: ${tool}" >&2
    exit 2
  fi
done

start_dir="$(pwd)"
lcov_ignore="${LCOV_IGNORE_ERRORS:-deprecated,gcov,inconsistent,unused}"
build_dir="${start_dir}"
while [ "${build_dir}" != "/" ] && [ ! -f "${build_dir}/CMakeCache.txt" ]; do
  build_dir="$(dirname "${build_dir}")"
done
if [ ! -f "${build_dir}/CMakeCache.txt" ]; then
  echo "Could not locate CMakeCache.txt; run this inside a casacore build tree." >&2
  exit 2
fi

case "${start_dir}" in
  "${build_dir}")
    rel_dir=""
    ;;
  "${build_dir}"/*)
    rel_dir="${start_dir#${build_dir}}"
    ;;
  *)
    echo "Current directory is not under detected build tree: ${build_dir}" >&2
    exit 2
    ;;
esac

# If running from a test directory, scope coverage to its parent module part.
scope_dir="${rel_dir%/test}"
if [ -z "${scope_dir}" ]; then
  scope_glob="*casacore/*"
  scope_label="all modules"
else
  scope_glob="*casacore${scope_dir}/*"
  scope_label="${scope_dir#/}"
fi

echo "Initializing coverage counters for scope: ${scope_label}"
lcov --ignore-errors "${lcov_ignore}" --zerocounters --directory "${build_dir}" > testcov.log 2>&1
lcov --rc lcov_function_coverage=0 --capture --initial \
     --ignore-errors "${lcov_ignore}" \
     --directory "${build_dir}" --output-file testcov.bl >> testcov.log 2>&1

echo "Running tests from ${start_dir}"
set -- ctest
if [ -n "${CTEST_REGEX:-}" ]; then
  set -- "$@" -R "${CTEST_REGEX}"
fi
if [ -n "${CTEST_ARGS:-}" ]; then
  # shellcheck disable=SC2086
  set -- "$@" ${CTEST_ARGS}
fi
"$@" >> testcov.log 2>&1

echo "Collecting coverage traces"
lcov --rc lcov_function_coverage=0 --rc lcov_branch_coverage=1 --no-checksum \
     --ignore-errors "${lcov_ignore}" \
     --capture --directory "${build_dir}" --output-file testcov.data >> testcov.log 2>&1
lcov --rc lcov_function_coverage=0 --rc lcov_branch_coverage=1 \
     --ignore-errors "${lcov_ignore}" \
     -a testcov.bl -a testcov.data -o testcov.info >> testcov.log 2>&1

echo "Filtering scope traces"
lcov --rc lcov_function_coverage=0 --rc lcov_branch_coverage=1 \
     --ignore-errors "${lcov_ignore}" \
     --output-file testcov.full --extract testcov.info "${scope_glob}" >> testcov.log 2>&1
lcov --rc lcov_function_coverage=0 --rc lcov_branch_coverage=1 \
     --ignore-errors "${lcov_ignore}" \
     --output-file testcov.module --remove testcov.full "*/test/*" >> testcov.log 2>&1

echo "Rendering HTML report at ./cov/index.html"
rm -rf cov
if ! genhtml --ignore-errors "${lcov_ignore},corrupt" \
             --rc lcov_function_coverage=0 --rc lcov_branch_coverage=1 \
             --output-directory=cov testcov.module >> testcov.log 2>&1; then
  echo "genhtml reported issues; summary data is still available in testcov.summary" \
    >> testcov.log
fi

lcov --rc lcov_function_coverage=0 --rc lcov_branch_coverage=1 \
     --ignore-errors "${lcov_ignore}" \
     --summary testcov.module > testcov.summary 2>> testcov.log

echo "Coverage summary (${scope_label}):"
grep -E "lines\\.|functions\\.|branches\\." testcov.summary || true
echo "Ready; details in ./testcov.log and ./testcov.summary"
